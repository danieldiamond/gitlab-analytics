# Job definitions
#
.job_template: &extract_definition
  image: registry.gitlab.com/meltano/meltano-elt/extract:latest
  tags:
    - analytics

.meltano_config: &meltano_default_variables
  SINGER_RUN_DIR: /run/singer
  TAP_OUTPUT: $SINGER_RUN_DIR/tap-zendesk.out
  TARGET_REJECTED_DIR: $SINGER_RUN_DIR/target-postgres
  MELTANO_JOB_ID: $CI_JOB_NAME

.marketo_extract: &marketo_extract
  stage: extract
  <<: *extract_definition
  script:
    - ci_helpers.py use_proxy "bash extract/mkto/mkto_processor.sh"

.zendesk_extract: &zendesk_extract
  stage: extract
  <<: *extract_definition
  script:
    - ci_helpers.py use_proxy "python3 extract/zendesk/src --schema zendesk apply_schema"
    - ci_helpers.py use_proxy "python3 extract/zendesk/src --schema zendesk --days=1 export"

.zendesk_singer_extract: &zendesk_singer_extract
  stage: extract
  <<: *extract_definition
  image:
    name: registry.gitlab.com/meltano/meltano/singer_runner:latest
    entrypoint: [""]
  variables:
    <<: *meltano_default_variables
    PG_SCHEMA: zendesk_singer
    MELTANO_EXTRACTOR: tap-zendesk
    MELTANO_LOADER: target-postgres
  script:
    - pip install -r orchestration/requirements.txt # TODO: add this to `meltano/meltano/runner`
    # - check_ci_cd_vars.py --file extract/singer/required_ci_cd_vars.yaml
    # - check_ci_cd_vars.py --file load/singer/required_ci_cd_vars.yaml
    #
    # NOTE: to overwrite the sample fields configuration
    # - cp path/to/properties.json /etc/singer/tap/tap-zendesk.properties.json
    #
    # - ci_helpers.py use_proxy "meltano schema create $PG_SCHEMA readonly analytics"
    - ci_helpers.py use_proxy "meltano extract $CI_JOB_NAME tap-zendesk --loader_name=target-postgres"
  artifacts:
    paths:
      - /run/singer/tap-zendesk.out
      - /run/singer/target-postgres/
    expire_in: 1 week

.zendesk_singer_snowflake_extract: &zendesk_singer_snowflake_extract
  <<: *zendesk_singer_extract
  variables:
    SINGER_RUN_DIR: /run/singer
    TAP_OUTPUT: $SINGER_RUN_DIR/tap-zendesk.out
    TARGET_REJECTED_DIR: $SINGER_RUN_DIR/target-postgres
    SF_SCHEMA: ZENDESK
    MELTANO_EXTRACTOR: tap-zendesk
    MELTANO_LOADER: target-snowflake
  script:
    - pip install -r orchestration/requirements.txt # TODO: add this to `meltano/meltano/runner`
    - ci_helpers.py use_proxy "meltano extract $CI_JOB_NAME tap-zendesk --loader_name=target-snowflake"

.lever_extract: &lever_extract
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/lever/src/config/required_ci_cd_vars.yaml
    - ci_helpers.py use_proxy "python3 extract/lever/src --schema lever apply_schema"
    - ci_helpers.py use_proxy "python3 extract/lever/src --schema lever --days=7 export"
    - ci_helpers.py use_proxy "python3 extract/lever/src --schema lever --days=365 --only_offers export"

.ci_stats: &ci_stats
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_ci_stats.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest ci_stats"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest ci_stats --hours 8"

.netsuite_extract: &netsuite_extract
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/netsuite/src/config/required_ci_cd_vars.yaml
    - ci_helpers.py use_proxy "python3 extract/netsuite/src/ --schema netsuite apply_schema"
    - ci_helpers.py use_proxy "python3 extract/netsuite/src/ --schema netsuite export --days 3"
    - ci_helpers.py use_proxy "python3 extract/netsuite/src/ --schema netsuite backlog --days 15"

.netsuite_backlog: &netsuite_backlog
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/netsuite/src/config/required_ci_cd_vars.yaml
    - ci_helpers.py use_proxy "python3 extract/netsuite/src/ --schema netsuite backlog --days 60"

.pings_extract: &pings_extract
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_pings.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest version"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest version --days 1"
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest customers"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest customers --days 1"
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest license"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest license --days 1"

.pings_backfill: &pings_backfill
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_pings.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest version"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest version"

.gitlab_profiler_extract: &gitlab_profiler_extract
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_gitlab_profiler.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest gitlab_profiler"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest gitlab_profiler --days 15"

.gitlab_profiler_backfill: &gitlab_profiler_backfill
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_gitlab_profiler.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src apply_schema --db_manifest gitlab_profiler"
    - ci_helpers.py use_proxy "python3 extract/pings/src export --db_manifest gitlab_profiler --days 3600"

.sheetload: &sheetload
  stage: extract
  <<: *extract_definition
  script:
    - pip3 install -U pyasn1-modules
    - ci_helpers.py use_proxy "python3 extract/historical/sheetload.py sheet
          historical.sales_quota.sales_quota
          historical.headcount.headcount
          historical.metrics.metrics
          historical.regional_quotas.transposed
          historical.google_referrals.google_referrals
          historical.sales_weekly_forecast.sales_weekly_forecast
          historical.ccodashboard.ccodashboard_actuals
          historical.ccodashboard.ccodashboard_goals
          historical.crodashboard.crodashboard_actuals
          historical.crodashboard.crodashboard_goals
          historical.cfodashboard.cfodashboard_actuals
          historical.cfodashboard.cfodashboard_goals
          historical.vpedashboard.vpedashboard_actuals
          historical.vpedashboard.vpedashboard_goals
          historical.cmodashboard.cmodashboard_actuals
          historical.cmodashboard.cmodashboard_goals
          historical.alliancesdashboard.alliancesdashboard_actuals
          historical.alliancesdashboard.alliancesdashboard_goals"

.zuora_extract: &zuora_extract
  variables:
    FIXED_ZUORA_PASSWORD: $ZUORA_PASSWORD
  stage: extract
  <<: *extract_definition
  script:
    - envsubst < "extract/config/environment.conf.template" > "extract/config/environment.conf"
    - ci_helpers.py use_proxy "python3 extract/zuora/zuora_export.py"

.sfdc_extract: &sfdc_extract
  variables:
    FIXED_SFDC_PASSWORD: $SFDC_PASSWORD_NOTOKEN
  stage: extract
  <<: *extract_definition
  script:
    - pip3 install salesforce-bulk # TODO: add me to the container
    - ci_helpers.py use_proxy "python3 extract/sfdc/src/ --schema sfdc apply_schema"
    - ci_helpers.py use_proxy "python3 extract/sfdc/src/ --schema sfdc export"

.domains_extract: &domains_extract
  stage: extract
  <<: *extract_definition
  script:
    - ci_helpers.py use_proxy "bash transform/hosts_to_sfdc/python_timecheck.sh"

.stripe_extract_githost: &stripe_extract_githost
  variables:
    GITHOST_STRIPE_API_KEY_SK: $GITHOST_STRIPE_API_KEY_SK
  stage: extract
  <<: *extract_definition
  script:
    - ci_helpers.py use_proxy "python3 extract/stripe/src --schema stripe_githost apply_schema"
    - ci_helpers.py use_proxy "python3 extract/stripe/src --schema stripe_githost --days=7 export"

.stripe_extract_about_gitlab: &stripe_extract_about_gitlab
  variables:
    ABOUT_GITLAB_STRIPE_API_KEY_SK: $ABOUT_GITLAB_STRIPE_API_KEY_SK
  stage: extract
  <<: *extract_definition
  script:
    - ci_helpers.py use_proxy "python3 extract/stripe/src --schema stripe_about_gitlab apply_schema"
    - ci_helpers.py use_proxy "python3 extract/stripe/src --schema stripe_about_gitlab --days=7 export"

.gitlab_extract: &gitlab_extract
  stage: extract
  retry: 1
  <<: *extract_definition
  script:
    - ci_helpers.py use_proxy "python3 extract/gitlab/src -S gitlab apply_schema"
    - ci_helpers.py use_proxy "python3 extract/gitlab/src -S gitlab export"

.discover_gitlab_dbs_schema: &discover_gitlab_dbs_schema
  stage: extract
  <<: *extract_definition
  script:
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_ci_stats.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src discover_schema --db_manifest ci_stats"
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_pings.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src discover_schema --db_manifest version"
    - ci_helpers.py use_proxy "python3 extract/pings/src discover_schema --db_manifest customers"
    - ci_helpers.py use_proxy "python3 extract/pings/src discover_schema --db_manifest license"
    - check_ci_cd_vars.py --file extract/pings/src/config/required_vars_gitlab_profiler.yaml
    - ci_helpers.py use_proxy "python3 extract/pings/src discover_schema --db_manifest gitlab_profiler"

## Production Jobs

ci_stats:
  <<: *ci_stats
  only:
    refs:
      - master
    variables:
      - $CI_STATS

domains:
  <<: *domains_extract
  only:
    refs:
      - master
    variables:
      - $DOMAINS

gitlab:
  <<: *gitlab_extract
  only:
    refs:
      - master
    variables:
      - $GITLAB

lever:
  <<: *lever_extract
  only:
    refs:
      - master
    variables:
      - $LEVER

marketo:
  <<: *marketo_extract
  only:
    refs:
      - master
    variables:
      - $MARKETO

netsuite:
  <<: *netsuite_extract
  only:
    refs:
      - master
    variables:
      - $NETSUITE

pings:
  stage: extract
  <<: *pings_extract
  only:
    refs:
      - master
    variables:
      - $PINGS

gitlab_profiler:
  <<: *gitlab_profiler_extract
  only:
    refs:
      - master
    variables:
      - $GITLAB_PROFILER

sfdc:
  <<: *sfdc_extract
  only:
    refs:
      - master
    variables:
      - $SFDC

sheetload:
  stage: extract
  <<: *sheetload
  only:
    refs:
      - master
    variables:
      - $SHEETLOAD

stripe_about_gitlab:
  <<: *stripe_extract_about_gitlab
  only:
    refs:
      - master
    variables:
      - $STRIPE_ABOUT_GITLAB

stripe_githost:
  <<: *stripe_extract_githost
  only:
    refs:
      - master
    variables:
      - $STRIPE_GITHOST

zendesk:
  <<: *zendesk_extract
  only:
    refs:
      - master
    variables:
      - $ZENDESK

zendesk:
  <<: *zendesk_singer_extract
  only:
    refs:
      - master
    variables:
      - $ZENDESK

zendesk_snowflake:
  <<: *zendesk_singer_snowflake_extract
  only:
    refs:
      - master
    variables:
      - $ZENDESK

zuora:
  <<: *zuora_extract
  only:
    refs:
      - master
    variables:
      - $ZUORA

## Review Jobs

ci_stats_manual:
  stage: extract
  <<: *ci_stats
  only:
    - branches
  except:
    - master
  when: manual

domains_manual:
  <<: *domains_extract
  only:
    - branches
  except:
    - master
  when: manual

gitlab_manual:
  <<: *gitlab_extract
  only:
    - branches
  except:
    - master
  when: manual

lever_manual:
  <<: *lever_extract
  only:
    - branches
  except:
    - master
  when: manual

marketo_manual:
  <<: *marketo_extract
  only:
    - branches
  except:
    - master
  when: manual

netsuite_backlog_manual:
  stage: extract
  <<: *netsuite_backlog
  when: manual

netsuite_manual:
  <<: *netsuite_extract
  only:
    - branches
  except:
    - master
  when: manual

pings_manual:
  stage: extract
  <<: *pings_extract
  only:
    - branches
  except:
    - master
  when: manual

pings_backfill:
  stage: extract
  <<: *pings_backfill
  only:
    - master
  when: manual

gitlab_profiler_manual:
  stage: extract
  <<: *gitlab_profiler_backfill
  only:
    - branches
  except:
    - master
  when: manual

gitlab_profiler_backfill:
  stage: extract
  <<: *gitlab_profiler_backfill
  only:
    - master
  when: manual

discover_gitlab_dbs_schema_manual:
  stage: extract
  <<: *discover_gitlab_dbs_schema
  only:
    - branches
  except:
    - master
  when: manual

sfdc_manual:
  <<: *sfdc_extract
  only:
    - branches
  except:
    - master
  when: manual

sheetload_manual:
  stage: extract
  <<: *sheetload
  when: manual

stripe_extract_about_gitlab_manual:
  <<: *stripe_extract_about_gitlab
  only:
    - branches
  except:
    - master
  when: manual

stripe_extract_githost_manual:
  <<: *stripe_extract_githost
  only:
    - branches
  except:
    - master
  when: manual

zendesk_manual:
  <<: *zendesk_extract
  only:
    - branches
  except:
    - master
  when: manual

zendesk_singer_manual:
  <<: *zendesk_singer_extract
  only:
    - branches
  except:
    - master
  when: manual

zendesk_singer_snowflake_manual:
  <<: *zendesk_singer_snowflake_extract
  variables:
  only:
    - branches
  except:
    - master
  when: manual

zuora_manual:
  <<: *zuora_extract
  only:
    - branches
  except:
    - master
  when: manual


# Stage: test

.test_job_template: &test_job_template
  image: registry.gitlab.com/meltano/meltano-elt/extract:latest

run_tests_manual:
  stage: test
  <<: *test_job_template
  script:
    - ci_helpers.py use_proxy "pytest -vv"
  when: manual

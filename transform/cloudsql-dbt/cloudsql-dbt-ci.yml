.cloudsql_dbt_jobs: &cloudsql_dbt_jobs
  image: registry.gitlab.com/meltano/meltano-elt/extract:latest
  before_script:
    - export PATH="$CI_PROJECT_DIR/orchestration/:$PATH"
    - cd transform/cloudsql-dbt
  variables:
    MELT_CI_RETRIES: 0
  tags:
    - analytics

dbt_cloudsql: &dbt_cloudsql
  stage: model
  <<: *cloudsql_dbt_jobs
  script:
    - ci_helpers.py use_proxy "dbt deps --profiles-dir profile"
    - ci_helpers.py use_proxy "dbt run --profiles-dir profile --target prod"
  only:
    refs:
      - master
    variables:
      - $CLOUDSQL_DBT

dbt_cloudsql_manual:
  <<: *dbt_cloudsql
  only:
    refs:
      - branches
  when: manual

dbt_full_refresh:
  stage: model
  <<: *cloudsql_dbt_jobs
  script:
    - ci_helpers.py use_proxy "dbt deps --profiles-dir profile"
    - ci_helpers.py use_proxy "dbt run --profiles-dir profile --target prod --full-refresh"
  when: manual

cloudsql_mr_dbt:
  stage: model
  <<: *cloudsql_dbt_jobs
  script:
    - ci_helpers.py use_proxy "dbt deps --profiles-dir profile"
    - ci_helpers.py use_proxy "dbt run --profiles-dir profile --target prod --full-refresh"
    - ci_helpers.py use_proxy "dbt run --profiles-dir profile --target prod"
    - ci_helpers.py use_proxy "dbt test --profiles-dir profile --target prod"
  when: manual

# Model Tests
dbt_cloudsql_tests: &dbt_cloudsql_tests
  stage: model_tests
  <<: *cloudsql_dbt_jobs
  script:
    - ci_helpers.py use_proxy "dbt test --profiles-dir profile --target prod"
  only:
    refs:
      - master
    variables:
      - $CLOUDSQL_DBT_TESTS

dbt_cloudsql_tests_manual:
  <<: *dbt_cloudsql_tests
  only:
    refs:
      - branches
  when: manual
